<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... existing head content ... -->
</head>
<body>

    <!-- ... existing body content ... -->

    <script>
        // Init Stat Dropdowns
        const statSelects = document.querySelectorAll('.stat-select');
        statSelects.forEach(sel => {
            const randOpt = document.createElement('option');
            randOpt.value = 'random';
            randOpt.textContent = 'ðŸŽ² Roll';
            sel.appendChild(randOpt);
            
            for(let i=3; i<=18; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                if(i===10) opt.selected = false; 
                sel.appendChild(opt);
            }
        });

        const names = {
            Male: ["Enoch", "Nimrod", "Gilgamesh", "Methuselah", "Jared", "Lamech", "Barak", "Goliath", "Og", "Sennacherib", "Nebuchadnezzar", "Cyrus", "Darius", "Tubal-Cain", "Canaan", "Hittite"],
            Female: ["Lilith", "Semiramis", "Jezebel", "Deborah", "Salome", "Athaliah", "Hagar", "Tiamat", "Ishtar", "Naamah", "Delilah", "Bathsheba"],
            Androgynous: ["Azazel", "Samyaza", "Baraqiel", "Kokabiel", "Tamiel", "Ramiel", "Daniel", "Uriel", "Sariel"]
        };

        const titles = ["the Accursed", "of the Watchers", "the Giant", "Light-Bringer", "of Ur", "the Scribe", "Star-Gazer", "Iron-Heart", "Baal-Worshipper", "Yahweh-Fearer", "of the Dust", "the Unclean", "of the Pit"];

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getStatValue(id) {
            const val = document.getElementById(id).value;
            if(val === 'random') return getRandomInt(8, 15); // Standard roll range
            return parseInt(val);
        }

        function generateStats(cls) {
            // Get base stats (either random or manual override)
            let stats = {
                str: getStatValue('base-str'),
                dex: getStatValue('base-dex'),
                con: getStatValue('base-con'),
                int: getStatValue('base-int'),
                wis: getStatValue('base-wis'),
                cha: getStatValue('base-cha')
            };
            
            // Add Class Bonuses (Mechanics apply on top of base)
            if(cls === 'Gibbor' || cls === 'Hunter' || cls === 'Gammadim' || cls === 'Zamzummim') { stats.str += 4; stats.con += 2; }
            if(cls === 'Nazarite' || cls === 'Kohen' || cls === 'Judge') { stats.wis += 4; stats.cha += 2; }
            if(cls === 'Magi' || cls === 'Scribe' || cls === 'Ov' || cls === 'Artificer') { stats.int += 5; stats.wis += 2; }
            if(cls === 'Malakh' || cls === 'Charioteer') { stats.dex += 4; stats.int += 1; }
            
            return stats;
        }

        function generateCharacter() {
            // 1. Gather Data
            const customName = document.getElementById('custom-name').value;
            const race = document.getElementById('race').value;
            const cls = document.getElementById('class').value;
            const sex = document.getElementById('sex').value;
            const background = document.getElementById('background').value;
            const build = document.getElementById('build').value;
            const skin = document.getElementById('skin').value;
            const hair = document.getElementById('hair').value;
            const eyes = document.getElementById('eyes').value;
            const trait1 = document.getElementById('trait1').value;
            const trait2 = document.getElementById('trait2').value;
            const vibe = document.getElementById('vibe').value;

            // 2. Generate Prompt for AI (Updated for PHOTOREALISM)
            let prompt = `cinematic shot, 35mm photograph, live action movie still, ancient near east, ${sex} ${race} ${cls}, ${build} body, ${skin} skin, ${hair} hair, ${eyes} eyes, wearing ancient bronze age armor and robes.`;
            
            if(trait1) prompt += ` Distinct feature: ${trait1}.`;
            if(trait2) prompt += ` Holding: ${trait2}.`;
            
            prompt += ` Background: ${vibe}. Style: hyperrealistic, highly detailed skin texture, sharp focus, volumetric lighting, 8k uhd, HDR, anatomically correct, masterpiece.`;

            // Negative Prompt
            const negative = "cartoon, anime, illustration, painting, drawing, cgi, 3d render, sketch, low quality, deformed, ugly, blur, bad anatomy, extra limbs, disfigured, watermark, text";

            // 3. Update UI - Text
            let name = "";
            if (customName.trim() !== "") {
                name = customName;
            } else {
                const firstNames = names[sex] || names['Male'];
                name = firstNames[Math.floor(Math.random() * firstNames.length)] + " " + titles[Math.floor(Math.random() * titles.length)];
            }

            const cleanRace = race.split(' ')[0];
            const cleanClass = cls.split(' ')[0];
            
            document.getElementById('display-name').innerText = name;
            document.getElementById('display-subtitle').innerText = `${cleanRace} ${cleanClass} (${background})`;

            const stats = generateStats(cleanClass);
            document.getElementById('str-val').innerText = stats.str;
            document.getElementById('dex-val').innerText = stats.dex;
            document.getElementById('con-val').innerText = stats.con;
            document.getElementById('int-val').innerText = stats.int;
            document.getElementById('wis-val').innerText = stats.wis;
            document.getElementById('cha-val').innerText = stats.cha;

            // 4. Update UI - Image
            const imgElement = document.getElementById('char-image');
            const loading = document.getElementById('loading');
            const placeholder = document.getElementById('placeholder');

            imgElement.style.display = 'none';
            placeholder.style.display = 'none';
            loading.style.display = 'block';

            const encodedPrompt = encodeURIComponent(prompt);
            const encodedNegative = encodeURIComponent(negative);
            const seed = Math.floor(Math.random() * 100000);
            
            // FIX: Reduced resolution to 320x480 for Speed. Kept ratio 2:3.
            const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=320&height=480&seed=${seed}&nologo=true&model=flux&negative=${encodedNegative}`;

            imgElement.onload = function() {
                loading.style.display = 'none';
                imgElement.style.display = 'block';
            };

            imgElement.src = imageUrl;
        }

        // Check if generateCharacter is defined
        console.log('Checking if generateCharacter is defined:', typeof generateCharacter !== 'undefined');
    </script>
</body>
</html>